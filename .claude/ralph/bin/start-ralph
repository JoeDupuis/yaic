#!/usr/bin/env bash
set -e

trap '' TERM HUP

export CLAUDE_PROJECT_DIR="$(pwd)"
RALPH_DIR=".claude/ralph"
PROMPT_FILE="$RALPH_DIR/prompt.md"
CONTROL_FILE="$RALPH_DIR/loop-control"

if [ -n "$1" ]; then
    PROMPT_OVERRIDE="$1"
elif [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: $PROMPT_FILE not found"
    echo "Usage: start-ralph [prompt]"
    exit 1
fi

touch "$CONTROL_FILE"

while [ -f "$CONTROL_FILE" ]; do

    if [ -n "$PROMPT_OVERRIDE" ]; then
        PROMPT_CONTENT="$PROMPT_OVERRIDE"
    else
        PROMPT_CONTENT=$(cat "$PROMPT_FILE")
    fi

    echo "Starting new session..."
    RALPH_WIGGUM_LOOP=true claude --permission-mode acceptEdits "$PROMPT_CONTENT" || true

    echo ""
    echo "Session ended. Checking if loop should continue..."
done
