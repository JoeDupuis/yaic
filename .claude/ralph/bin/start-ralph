#!/usr/bin/env bash
set -e

trap '' TERM HUP

export CLAUDE_PROJECT_DIR="$(pwd)"
RALPH_DIR=".claude/ralph"
PROMPT_FILE="$RALPH_DIR/prompt.md"
CONTROL_FILE="$RALPH_DIR/loop-control"

if [ -n "$1" ]; then
    PROMPT_OVERRIDE="$1"
elif [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: $PROMPT_FILE not found"
    echo "Usage: start-ralph [prompt]"
    exit 1
fi

touch "$CONTROL_FILE"

FEATURES_DIR="docs/agents/ralph/features"

while [ -f "$CONTROL_FILE" ]; do
    REMAINING=$(find "$FEATURES_DIR" -name "*.md" ! -name "*.md.done" 2>/dev/null | wc -l | tr -d ' ')
    if [ "$REMAINING" -eq 0 ]; then
        echo "All features complete. Exiting loop."
        rm -f "$CONTROL_FILE"
        exit 0
    fi

    echo "Features remaining: $REMAINING"

    if [ -n "$PROMPT_OVERRIDE" ]; then
        PROMPT_CONTENT="$PROMPT_OVERRIDE"
    else
        PROMPT_CONTENT=$(cat "$PROMPT_FILE")
    fi

    echo "Starting new session..."
    RALPH_WIGGUM_LOOP=true claude --permission-mode acceptEdits "$PROMPT_CONTENT" || true

    echo ""
    echo "Session ended. Checking if loop should continue..."
done
