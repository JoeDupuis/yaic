#!/usr/bin/env bash
set -e

RALPH_DIR=".claude/ralph"
PROMPT_FILE="$RALPH_DIR/prompt.md"
CONTROL_FILE="$RALPH_DIR/loop-control"

if [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: $PROMPT_FILE not found"
    echo "Run the spec-builder first to generate the prompt file."
    exit 1
fi

touch "$CONTROL_FILE"
START_TIME=$(stat -f %m "$CONTROL_FILE" 2>/dev/null || stat -c %Y "$CONTROL_FILE")

while true; do
    CURRENT_TIME=$(stat -f %m "$CONTROL_FILE" 2>/dev/null || stat -c %Y "$CONTROL_FILE")
    if [ "$CURRENT_TIME" != "$START_TIME" ]; then
        echo "Loop stop requested. Exiting."
        exit 0
    fi

    PROMPT_CONTENT=$(cat "$PROMPT_FILE")

    echo "Starting new session..."
    RALPH_WIGGUM_LOOP=true claude "$PROMPT_CONTENT" || true

    echo ""
    echo "Session ended. Checking if loop should continue..."
done
